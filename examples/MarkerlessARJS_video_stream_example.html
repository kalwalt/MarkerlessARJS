<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=1">
    <title>MarkerlessARJS.js video stream example</title>
    <style>
        #video {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            z-index: 20;
        }
    </style>
</head>

<body>
    <img id="pinball" width="1637" height="2048" src="../../data/pinball.jpg" style="display: none" />
    <!--<img id="pinball-test" width="4000" height="3000" src="../../data/pinball-test.jpg" style="display: none" />-->
    <canvas id="canvas" width="1280" height="720"
        style="position:absolute; top:0; left:0; width: 100% !important; height: 100% !important;z-index:80"></canvas>
    <canvas id="targetCanvas" width="1280" height="720"
        style="position:absolute; top:0; left:0; width: 100% !important; height: 100% !important;z-index:80"></canvas>
    <video loop autoplay muted playsinline id="video"></video>

    <script src="../build/lib/MarkerlessARJS.js"></script>
    <script src="../data/three.min.js"></script>
    <!--<script src="../build/lib/renderer.js"></script>-->
    <script src="initCamera.js"></script>
    <script>
        var setMatrix = function (matrix, value) {
            var array = [];
            for (var key in value) {
                array[key] = value[key];
            }
            if (typeof matrix.elements.set === "function") {
                matrix.elements.set(array);
            } else {
                matrix.elements = [].slice.call(array);
            }
        };
        function isMobile() {
            return /Android|mobile|iPad|iPhone/i.test(navigator.userAgent);
        }
        var canvasElement = document.getElementById('canvas');
        var context_process = canvasElement.getContext('2d', { willReadFrequently: true });
        var pipeline;
        var oWidth = 1280;
        var oHeight = 720;

        var vw, vh;
        var sw, sh;
        var pscale, sscale;
        var w, h;
        var pw, ph;

        vw = oWidth;
        vh = oHeight;

        pscale = 320 / Math.max(vw, vh / 3 * 4);
        sscale = isMobile() ? window.outerWidth / oWidth : 1;

        sw = vw * sscale;
        sh = vh * sscale;

        w = vw * pscale;
        h = vh * pscale;
        pw = Math.max(w, h / 3 * 4);
        ph = Math.max(h, w / 4 * 3);

        Module.onRuntimeInitialized = async function () {

            createOverlayCanvas();

            initCamera(oWidth, oHeight)
                .then(video =>
                // start camera playback
                {
                    var sourceVideo = video;
                    sourceVideo.width = oWidth;
                    sourceVideo.height = oHeight;
                    sourceVideo.play();
                    console.log(sourceVideo);
                    return new Promise(resolve => {
                        sourceVideo.addEventListener("loadeddata", event => {
                            console.log("Camera is ready");
                            resolve();
                        });
                    });

                }
                )
                .then(_ => {
                    console.log(video);
                    const targetCanvas = document.getElementById('targetCanvas');

                    const renderer = new THREE.WebGLRenderer({ canvas: targetCanvas, alpha: true, antialias: true });
                    renderer.setPixelRatio(window.devicePixelRatio);

                    const scene = new THREE.Scene();

                    const camera = new THREE.PerspectiveCamera(75, oWidth / oHeight, 0.1, 1000);

                    camera.matrixAutoUpdate = false;

                    camera.add(scene);

                    var sphere = new THREE.Mesh(
                        new THREE.SphereGeometry(0.5, 8, 8),
                        new THREE.MeshNormalMaterial()
                    );

                    var root = new THREE.Object3D();
                    scene.add(root);

                    sphere.material.flatShading;
                    sphere.scale.set(.5, .5, .5);
                    sphere.visible = false;

                    root.matrixAutoUpdate = false;
                    root.add(sphere);

                    renderer.setSize(oWidth, oHeight);

                    var worker = new Worker('worker.js');

                    worker.onmessage = function (e) {
                        var msg = e.data;
                        if (msg.type == "projection_matrix") {              
                            var proj = JSON.parse(msg.projMat);
                            var ratioW = pw / w;
                            var ratioH = ph / h;
                            proj[0] *= ratioW;
                            proj[4] *= ratioW;
                            proj[8] *= ratioW;
                            proj[12] *= ratioW;
                            proj[1] *= ratioH;
                            proj[5] *= ratioH;
                            proj[9] *= ratioH;
                            proj[13] *= ratioH;
                            setMatrix(camera.projectionMatrix, proj);
                        }
                        if (msg.type == "pattern_found") {
                            let world = JSON.parse(msg.matrix);
                            let c = JSON.parse(msg.corners);
                            drawCorners(c);
                            if (!world) {
                                sphere.visible = false;
                           } else {
                                sphere.visible = true;
                                setMatrix(root.matrix, world);                   
                           }
                        }
                    }

                    var pinball_buff = imread('pinball');

                    worker.postMessage({ type: "pinball", buff: pinball_buff, width: 1637, height: 2048 });

                    function update() {
                        worker.postMessage({ type: "video_data", data: process(), videoWidth: oWidth, videoHeight: oHeight });
                        renderer.render(scene, camera);
                        requestAnimationFrame(update);
                    }

                    update();
                }
                );

        }

        var imread = function (imageSource) {
            var img = null;
            if (typeof imageSource === 'string') {
                img = document.getElementById(imageSource);
            } else {
                img = imageSource;
            }
            var canvas = null;
            var ctx = null;
            if (img instanceof HTMLImageElement) {
                canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx = canvas.getContext('2d', { willReadFrequently: true });
                ctx.drawImage(img, 0, 0, img.width, img.height);
            } else if (img instanceof HTMLCanvasElement || img instanceof OffscreenCanvas) {
                canvas = img;
                ctx = canvas.getContext('2d');
            } else {
                throw new Error('Please input the valid canvas or img id.');
                return;
            }

            var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            return imgData.data;
        };

        var process = function () {
            var w = oWidth;
            var h = oHeight;
            context_process.fillStyle = 'black';
            context_process.fillRect(0, 0, w, h);
            context_process.drawImage(video, 0, 0);
            var imageData = context_process.getImageData(0, 0, w, h);
            if (!imageData) return;
            return imageData.data
        }

        function setVideoStyle(elem) {
            elem.style.position = "absolute";
            elem.style.top = 0;
            elem.style.left = 0;
        }

        function createOverlayCanvas() {
            overlayCanvas = document.createElement("canvas");
            setVideoStyle(overlayCanvas);
            overlayCanvas.id = "overlay";
            overlayCanvas.width = oWidth;
            overlayCanvas.height = oHeight;
            overlayCanvas.style.zIndex = 100;
            //overlayCanvas.style.width = "1280px";
            document.body.appendChild(overlayCanvas);
        }

        function clearOverlayCtx() {
            const overlayCtx = overlayCanvas.getContext("2d");
            overlayCtx.clearRect(0, 0, oWidth, oHeight);
        }

        function drawCorners(corners) {
            const overlayCtx = overlayCanvas.getContext("2d");
            clearOverlayCtx();

            overlayCtx.beginPath();
            overlayCtx.strokeStyle = "blue";
            overlayCtx.lineWidth = 3;
            // [x1,y1,x2,y2,x3,y3,x4,y4]
            overlayCtx.moveTo(corners[0][0], corners[0][1]);
            overlayCtx.lineTo(corners[1][0], corners[1][1]);
            overlayCtx.lineTo(corners[2][0], corners[2][1]);
            overlayCtx.lineTo(corners[3][0], corners[3][1]);
            overlayCtx.lineTo(corners[0][0], corners[0][1]);

            overlayCtx.stroke();
        }

    </script>


</body>

</html>