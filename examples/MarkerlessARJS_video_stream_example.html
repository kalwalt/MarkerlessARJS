<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=1">
    <title>MarkerlessARJS.js basic example</title>
    <style>
        #video {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            z-index: 20;
        }
    </style>
</head>

<body>
    <img id="pinball" width="1637" height="2048" src="../../data/pinball.jpg" style="display: none" />
    <img id="pinball-test" width="4000" height="3000" src="../../data/pinball-test.jpg" style="display: none" />
    <canvas id="canvas" width="640" height="480" style="position:absolute; top:0; left:0; width:1280px; z-index:80">
        <video loop autoplay muted playsinline id="video"></video>

        <script src="../build/lib/MarkerlessARJS.js"></script>
        <script src="../data/three.min.js"></script>
        <!--<script src="../build/lib/renderer.js"></script>-->
        <script src="initCamera.js"></script>
        <script>
            var canvasElement = document.getElementById('canvas');
            var context_process = canvasElement.getContext('2d', { willReadFrequently: true });
            var pipeline;
            var oWidth = 640;
            var oHeight = 480;

            Module.onRuntimeInitialized = async function () {

                createOverlayCanvas();


                initCamera()
                    .then(video =>
                    // start camera playback
                    {
                        var sourceVideo = video;
                        sourceVideo.width = 640;
                        sourceVideo.height = 480;
                        sourceVideo.play();
                        console.log(sourceVideo);
                        return new Promise(resolve => {
                            sourceVideo.addEventListener("loadeddata", event => {
                                console.log("Camera is ready");
                                resolve();
                            });
                        });

                    }
                    )
                    .then(_ => {
                        console.log(video);

                        var worker = new Worker('worker.js');

                        worker.onmessage = function (e) {
                            var msg = e.data;
                            if (msg.type == "pattern_found") {
                                console.log(JSON.parse(msg.matrix));
                                console.log(msg.corners);
                                drawCorners(msg.corners)
                            }

                        }

                        var pinball_buff = imread('pinball');

                        worker.postMessage({ type: "pinball", buff: pinball_buff, width: 1637, height: 2048 });

                        function update() {
                            worker.postMessage({ type: "video_data", data: process() });
                            requestAnimationFrame(update);
                        }

                        update();
                    }
                    );

            }

            var imread = function (imageSource) {
                var img = null;
                if (typeof imageSource === 'string') {
                    img = document.getElementById(imageSource);
                } else {
                    img = imageSource;
                }
                var canvas = null;
                var ctx = null;
                if (img instanceof HTMLImageElement) {
                    canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx = canvas.getContext('2d', { willReadFrequently: true });
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                } else if (img instanceof HTMLCanvasElement || img instanceof OffscreenCanvas) {
                    canvas = img;
                    ctx = canvas.getContext('2d');
                } else {
                    throw new Error('Please input the valid canvas or img id.');
                    return;
                }

                var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                return imgData.data;
            };

            var process = function () {
                var w = 640;
                var h = 480;
                context_process.fillStyle = 'black';
                context_process.fillRect(0, 0, w, h);
                context_process.drawImage(video, 0, 0);
                var imageData = context_process.getImageData(0, 0, w, h);
                if (!imageData) return;
                return imageData.data
            }

            function setVideoStyle(elem) {
                elem.style.position = "absolute";
                elem.style.top = 0;
                elem.style.left = 0;
            }

            function createOverlayCanvas() {
                overlayCanvas = document.createElement("canvas");
                setVideoStyle(overlayCanvas);
                overlayCanvas.id = "overlay";
                overlayCanvas.width = oWidth;
                overlayCanvas.height = oHeight;
                overlayCanvas.style.zIndex = 100;
                overlayCanvas.style.width = "1280px";
                document.body.appendChild(overlayCanvas);
            }

            function clearOverlayCtx() {
                const overlayCtx = overlayCanvas.getContext("2d");
                overlayCtx.clearRect(0, 0, oWidth, oHeight);
            }

            function drawCorners(corners) {
                const overlayCtx = overlayCanvas.getContext("2d");
                clearOverlayCtx();

                overlayCtx.beginPath();
                overlayCtx.strokeStyle = "blue";
                overlayCtx.lineWidth = 8;

                // [x1,y1,x2,y2,x3,y3,x4,y4]
                overlayCtx.moveTo(corners[0][0], corners[0][1]);
                overlayCtx.lineTo(corners[1][0], corners[1][1]);
                overlayCtx.lineTo(corners[2][0], corners[2][1]);
                overlayCtx.lineTo(corners[3][0], corners[3][1]);
                overlayCtx.lineTo(corners[0][0], corners[0][1]);

                overlayCtx.stroke();
            }

        </script>


</body>

</html>